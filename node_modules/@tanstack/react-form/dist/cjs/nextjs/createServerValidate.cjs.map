{"version":3,"file":"createServerValidate.cjs","sources":["../../../src/nextjs/createServerValidate.ts"],"sourcesContent":["import { decode } from 'decode-formdata'\nimport { ServerValidateError } from './error'\nimport type {\n  FormOptions,\n  FormValidationError,\n  ValidationError,\n  Validator,\n} from '@tanstack/form-core'\nimport type { ServerFormState } from './types'\n\ntype OnServerValidateFn<TFormData> = (props: {\n  value: TFormData\n}) => ValidationError | Promise<ValidationError>\n\ntype OnServerValidateOrFn<\n  TFormData,\n  TFormValidator extends Validator<TFormData, unknown> | undefined = undefined,\n> =\n  TFormValidator extends Validator<TFormData, infer FFN>\n    ? FFN | OnServerValidateFn<TFormData>\n    : OnServerValidateFn<TFormData>\n\ninterface CreateServerValidateOptions<\n  TFormData,\n  TFormValidator extends Validator<TFormData, unknown> | undefined = undefined,\n> extends FormOptions<TFormData, TFormValidator> {\n  onServerValidate: OnServerValidateOrFn<TFormData, TFormValidator>\n}\n\nconst isFormValidationError = (\n  error: unknown,\n): error is FormValidationError<unknown> => {\n  return typeof error === 'object'\n}\n\nexport const createServerValidate =\n  <\n    TFormData,\n    TFormValidator extends\n      | Validator<TFormData, unknown>\n      | undefined = undefined,\n  >(\n    defaultOpts: CreateServerValidateOptions<TFormData, TFormValidator>,\n  ) =>\n  async (formData: FormData, info?: Parameters<typeof decode>[1]) => {\n    const { validatorAdapter, onServerValidate } = defaultOpts\n\n    const runValidator = async (propsValue: {\n      value: TFormData\n      validationSource: 'form'\n    }) => {\n      if (validatorAdapter && typeof onServerValidate !== 'function') {\n        return validatorAdapter().validateAsync(propsValue, onServerValidate)\n      }\n\n      return (onServerValidate as OnServerValidateFn<TFormData>)(propsValue)\n    }\n\n    const values = decode(formData, info) as never as TFormData\n\n    const onServerError = await runValidator({\n      value: values,\n      validationSource: 'form',\n    })\n\n    if (!onServerError) return\n\n    const onServerErrorStr =\n      onServerError &&\n      typeof onServerError !== 'string' &&\n      isFormValidationError(onServerError)\n        ? onServerError.form\n        : onServerError\n\n    const formState: ServerFormState<TFormData> = {\n      errorMap: {\n        onServer: onServerError,\n      },\n      values,\n      errors: onServerErrorStr ? [onServerErrorStr] : [],\n    }\n\n    throw new ServerValidateError({\n      formState,\n    })\n  }\n\nexport const initialFormState: ServerFormState<any> = {\n  errorMap: {\n    onServer: undefined,\n  },\n  values: undefined,\n  errors: [],\n}\n"],"names":["error","decode","ServerValidateError"],"mappings":";;;;AA6BA,MAAM,wBAAwB,CAC5BA,WAC0C;AAC1C,SAAO,OAAOA,WAAU;AAC1B;AAEO,MAAM,uBACX,CAME,gBAEF,OAAO,UAAoB,SAAwC;AAC3D,QAAA,EAAE,kBAAkB,iBAAA,IAAqB;AAEzC,QAAA,eAAe,OAAO,eAGtB;AACA,QAAA,oBAAoB,OAAO,qBAAqB,YAAY;AAC9D,aAAO,iBAAiB,EAAE,cAAc,YAAY,gBAAgB;AAAA,IAAA;AAGtE,WAAQ,iBAAmD,UAAU;AAAA,EACvE;AAEM,QAAA,SAASC,eAAAA,OAAO,UAAU,IAAI;AAE9B,QAAA,gBAAgB,MAAM,aAAa;AAAA,IACvC,OAAO;AAAA,IACP,kBAAkB;AAAA,EAAA,CACnB;AAED,MAAI,CAAC,cAAe;AAEd,QAAA,mBACJ,iBACA,OAAO,kBAAkB,YACzB,sBAAsB,aAAa,IAC/B,cAAc,OACd;AAEN,QAAM,YAAwC;AAAA,IAC5C,UAAU;AAAA,MACR,UAAU;AAAA,IACZ;AAAA,IACA;AAAA,IACA,QAAQ,mBAAmB,CAAC,gBAAgB,IAAI,CAAA;AAAA,EAClD;AAEA,QAAM,IAAIC,MAAAA,oBAAoB;AAAA,IAC5B;AAAA,EAAA,CACD;AACH;AAEK,MAAM,mBAAyC;AAAA,EACpD,UAAU;AAAA,IACR,UAAU;AAAA,EACZ;AAAA,EACA,QAAQ;AAAA,EACR,QAAQ,CAAA;AACV;;;"}